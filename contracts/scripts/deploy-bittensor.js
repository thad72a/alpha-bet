const hre = require("hardhat");
const fs = require("fs");
const path = require("path");

async function main() {
  console.log("ğŸš€ Starting deployment to Bittensor Testnet...\n");

  // Get network info
  const network = hre.network.name;
  const chainId = (await hre.ethers.provider.getNetwork()).chainId;
  
  console.log("ğŸ“¡ Network:", network);
  console.log("ğŸ”— Chain ID:", chainId);
  
  // Get deployer account
  const signers = await hre.ethers.getSigners();
  
  if (signers.length === 0) {
    console.error("âŒ Error: No signers available!");
    console.error("\nğŸ“ Please ensure you have set PRIVATE_KEY in .env.local");
    console.error("Example: PRIVATE_KEY=0x1234567890abcdef...\n");
    console.error("Location: /home/unicorn/alpha-bet/.env.local");
    process.exit(1);
  }
  
  const deployer = signers[0];
  console.log("ğŸ‘¤ Deploying with account:", deployer.address);
  
  // Check balance
  const balance = await hre.ethers.provider.getBalance(deployer.address);
  console.log("ğŸ’° Account balance:", hre.ethers.formatEther(balance), "tTAO\n");
  
  if (balance === 0n) {
    console.error("âŒ Error: Account has no tTAO balance!");
    console.log("Please fund your account with testnet tTAO before deploying.");
    process.exit(1);
  }

  // Deploy the BettingCard contract (no token address needed for native TAO)
  console.log("ğŸ“ Deploying BettingCard contract...");
  const BettingCard = await hre.ethers.getContractFactory("BettingCard");
  
  // Manual gas settings to bypass Bittensor testnet gas estimation bug
  const gasLimit = 10000000; // 10M gas
  const gasPrice = hre.ethers.parseUnits("30", "gwei"); // 30 gwei (base fee is ~20 gwei)
  
  console.log("â›½ Using manual gas settings (testnet workaround):");
  console.log("   Gas Limit:", gasLimit);
  console.log("   Gas Price:", hre.ethers.formatUnits(gasPrice, "gwei"), "gwei");
  
  const bettingCard = await BettingCard.deploy({
    gasLimit: gasLimit,
    gasPrice: gasPrice
  });
  
  console.log("â³ Waiting for deployment transaction...");
  await bettingCard.waitForDeployment();

  const bettingCardAddress = await bettingCard.getAddress();
  console.log("âœ… BettingCard deployed to:", bettingCardAddress);

  // Save deployment addresses
  const deploymentInfo = {
    network: network,
    chainId: Number(chainId),
    rpcUrl: network === 'bittensorTestnet' 
      ? 'https://test.chain.opentensor.ai' 
      : 'https://lite.chain.opentensor.ai',
    blockExplorer: 'https://evm.taostats.io',
    contracts: {
      BettingCard: bettingCardAddress,
      TAO: 'native' // Native TAO, not a contract
    },
    deployer: deployer.address,
    deployedAt: new Date().toISOString(),
    note: "TAO is native on Bittensor - no token contract address needed"
  };

  const deploymentsPath = path.join(__dirname, '../deployment-addresses.json');
  let allDeployments = {};
  
  // Read existing deployments if file exists
  if (fs.existsSync(deploymentsPath)) {
    try {
      allDeployments = JSON.parse(fs.readFileSync(deploymentsPath, 'utf8'));
    } catch (e) {
      console.log("âš ï¸  Could not read existing deployments file, creating new one");
    }
  }
  
  // Add or update this network's deployment
  allDeployments[network] = deploymentInfo;
  
  fs.writeFileSync(deploymentsPath, JSON.stringify(allDeployments, null, 2));
  console.log("ğŸ’¾ Deployment info saved to deployment-addresses.json");

  // Create/update .env.local file
  console.log("\nğŸ“ Creating .env.local file...");
  const envContent = `# Auto-generated by deploy script - ${new Date().toISOString()}

# Network Configuration
NEXT_PUBLIC_NETWORK=${network}
NEXT_PUBLIC_CHAIN_ID=${chainId}
NEXT_PUBLIC_RPC_URL=${deploymentInfo.rpcUrl}

# Smart Contract Addresses
NEXT_PUBLIC_BETTING_CONTRACT_ADDRESS=${bettingCardAddress}
# TAO is native on Bittensor - no token contract address needed

# Block Explorer
NEXT_PUBLIC_BLOCK_EXPLORER_URL=https://evm.taostats.io

# WalletConnect Project ID (get from https://cloud.walletconnect.com/)
NEXT_PUBLIC_WALLETCONNECT_PROJECT_ID=your_project_id_here

# Deployment Info
# Deployer: ${deployer.address}
# Deployed at: ${new Date().toISOString()}
`;

  const envPath = path.join(__dirname, '../../.env.local');
  fs.writeFileSync(envPath, envContent);
  console.log("âœ… .env.local file created!");

  // Log the deployment summary
  console.log("\n" + "=".repeat(60));
  console.log("ğŸ‰ DEPLOYMENT SUCCESSFUL!");
  console.log("=".repeat(60));
  console.log("Network:", network);
  console.log("Chain ID:", chainId);
  console.log("BettingCard Contract:", bettingCardAddress);
  console.log("Block Explorer:", `https://evm.taostats.io/address/${bettingCardAddress}`);
  console.log("\nâš ï¸  IMPORTANT:");
  console.log("1. Restart your Next.js dev server to pick up .env.local");
  console.log("2. Connect MetaMask to Bittensor Testnet (Chain ID: 945)");
  console.log("3. Add Bittensor Testnet to MetaMask:");
  console.log("   - Network Name: Bittensor Testnet");
  console.log("   - RPC URL: https://test.chain.opentensor.ai");
  console.log("   - Chain ID: 945");
  console.log("   - Currency Symbol: tTAO");
  console.log("   - Block Explorer: https://evm.taostats.io");
  console.log("=".repeat(60) + "\n");
}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error("âŒ Deployment failed:", error);
    process.exit(1);
  });

